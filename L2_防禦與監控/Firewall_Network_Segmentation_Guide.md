# 防火牆策略與網路分段設計指南
# Firewall Policy & Network Segmentation Design Guide

> **文件版本 Document Version**: v1.0  
> **最後更新 Last Updated**: 2026-02-16  
> **培訓時數 Training Hours**: 14小時 (P2改善級，5月初)  
> **優先級 Priority**: 🟡 P2 改善生存級  
> **受眾 Audience**: 網路工程師、系統管理員、安全架構師、IT主管  
> **前置條件 Prerequisites**: 理解TCP/IP網路基礎、VLAN概念、防火牆規則邏輯  
> **當前狀況 Current Status**: 單一DMZ區域，無微分段設計 ⚠️  
> **目標 Objectives**: 建立多層網路分段、最小權限防火牆規則、IDS/IPS部署、ISO 27001 A13.1.3合規

---

## 📋 課程大綱 Course Outline

### 模組1：網路分段策略與VLAN設計 (3小時)
**Network Segmentation Strategy & VLAN Design**

### 模組2：防火牆規則制訂與最小權限原則 (4小時)
**Firewall Policy Development & Least Privilege**

### 模組3：IDS/IPS部署與威脅偵測 (4小時)
**IDS/IPS Deployment & Threat Detection**

### 模組4：實施與監控 (3小時)
**Implementation & Monitoring**

---

## 第一天：網路分段設計
## Day 1: Network Segmentation Design (3 hours)

### 模組1.1：網路分段架構 (2小時)

```
當前網路架構分析 (Current State)

┌──────────────────────────────────────┐
│ 現有網路架構 (平面設計)              │
├──────────────────────────────────────┤
│                                      │
│  網際網路                            │
│      ↓                               │
│  防火牆 (FortiGate)                  │
│      ↓                               │
│  交換機 (Core Switch)                │
│      ↓                               │
│  ┌─────────────────────────────┐    │
│  │ 單一網路區域 (Flat Network) │    │
│  ├─────────────────────────────┤    │
│  │ 所有伺服器混合:              │    │
│  │ ├─ AD網域控制器              │    │
│  │ ├─ SQL Server               │    │
│  │ ├─ 檔案伺服器                │    │
│  │ ├─ 應用伺服器                │    │
│  │ ├─ 工作站 (100+)            │    │
│  │ ├─ 網路印表機                │    │
│  │ └─ IoT設備 (HVAC, 監控)    │    │
│  │                              │    │
│  │ 單一subnet: 10.0.0.0/20     │    │
│  │ 無隔離, 無控制, 無監控       │    │
│  │ 任何設備可連接任何設備       │    │
│  └─────────────────────────────┘    │
│                                      │
└──────────────────────────────────────┘

風險評估 (Risk Assessment):

❌ 平面網路的缺點:
├─ 橫向移動風險: 駭客入侵1台設備 → 可訪問所有
├─ 無隔離: 受感染機器可感染整個網路
├─ 無細粒度控制: 無法限制特定設備間通訊
├─ 監控困難: 無法識別異常流量
├─ 合規風險: ISO 27001 A13.1.3違反 ❌
└─ 事件影響: 小漏洞 → 全網路停機

案例: 2020 SolarWinds供應鏈攻擊
├─ 一個漏洞 → 訪問所有客戶全網
├─ 原因: 無網路分段
└─ 教訓: 微分段是必須的

─────────────────────────────────────

目標網路架構 (Desired State - 多層分段)

┌──────────────────────────────────────┐
│ 新網路架構 (分段設計)                │
├──────────────────────────────────────┤
│                                      │
│  網際網路                            │
│      ↓                               │
│  ┌─────────────────────────────┐    │
│  │ 防火牆 & WAF & IPS          │    │
│  └─────────────────────────────┘    │
│      ↓                               │
│  ┌─────────────────────────────┐    │
│  │ DMZ區域 (0信任)             │    │
│  ├─────────────────────────────┤    │
│  │ VLAN 100: 邊界               │    │
│  │ ├─ 網頁伺服器 (Web01-02)   │    │
│  │ └─ DNS外部 (DNS01)          │    │
│  └─────────────────────────────┘    │
│      ↓ (IPS檢測)                    │
│  ┌─────────────────────────────┐    │
│  │ 核心區域 (高信任)            │    │
│  ├─────────────────────────────┤    │
│  │ VLAN 200: 網域基礎設施       │    │
│  │ ├─ AD網域控制器              │    │
│  │ ├─ DNS內部 (DNS02)          │    │
│  │ ├─ NTP伺服器                 │    │
│  │ └─ 備份伺服器                │    │
│  │                              │    │
│  │ VLAN 210: 關鍵資料庫         │    │
│  │ ├─ SQL Server (Always On)   │    │
│  │ └─ 資料庫叢集                │    │
│  │                              │    │
│  │ VLAN 220: 應用層             │    │
│  │ ├─ AppServer 1-3            │    │
│  │ └─ API伺服器                 │    │
│  │                              │    │
│  │ VLAN 230: 檔案與列印         │    │
│  │ ├─ 檔案伺服器 (NAS)         │    │
│  │ └─ 列印伺服器                │    │
│  └─────────────────────────────┘    │
│      ↓ (IPS檢測)                    │
│  ┌─────────────────────────────┐    │
│  │ 使用者區域 (中信任)          │    │
│  ├─────────────────────────────┤    │
│  │ VLAN 310: 公司內網           │    │
│  │ ├─ 工作站 (100+)            │    │
│  │ ├─ BYOD設備                  │    │
│  │ └─ 網路印表機                │    │
│  └─────────────────────────────┘    │
│      ↓ (IPS檢測)                    │
│  ┌─────────────────────────────┐    │
│  │ 遠端區域 (低信任)            │    │
│  ├─────────────────────────────┤    │
│  │ VLAN 400: VPN使用者          │    │
│  │ └─ 遠端員工                  │    │
│  │                              │    │
│  │ VLAN 410: 訪客WiFi          │    │
│  │ └─ 訪客網路 (隔離)          │    │
│  └─────────────────────────────┘    │
│      ↓ (IPS檢測)                    │
│  ┌─────────────────────────────┐    │
│  │ 管理區域 (專用)              │    │
│  ├─────────────────────────────┤    │
│  │ VLAN 500: 管理網路           │    │
│  │ ├─ 防火牆管理介面            │    │
│  │ ├─ 交換機管理                │    │
│  │ ├─ Wazuh監控伺服器          │    │
│  │ └─ 堡壘主機 (Jump Host)     │    │
│  └─────────────────────────────┘    │
│      ↓ (IPS檢測)                    │
│  ┌─────────────────────────────┐    │
│  │ 隔離區域 (最低信任)          │    │
│  ├─────────────────────────────┤    │
│  │ VLAN 600: 開發/測試          │    │
│  │ ├─ 開發機器                  │    │
│  │ └─ 測試系統                  │    │
│  │                              │    │
│  │ VLAN 700: 待廢除系統         │    │
│  │ └─ 隔離舊設備                │    │
│  └─────────────────────────────┘    │
│                                      │
│ 設計原則:                            │
│ ✅ 零信任架構 (Zero Trust)          │
│ ✅ 最小權限 (Least Privilege)      │
│ ✅ 深度防禦 (Defense in Depth)      │
│ ✅ 完整監控 (Full Visibility)       │
│                                      │
└──────────────────────────────────────┘

VLAN設計詳細參數:

VLAN 100 - DMZ邊界 (0信任):
├─ 用途: 向外開放的公共服務
├─ IP範圍: 192.168.100.0/24
├─ 設備:
│   ├─ Web01 (192.168.100.10)
│   ├─ Web02 (192.168.100.11) [負載平衡]
│   └─ DNS公開 (192.168.100.20)
├─ 防火牆規則:
│   ├─ 入站: 來自網際網路 (HTTP/HTTPS)
│   ├─ 出站: 僅限特定伺服器(SQL, AD)
│   └─ 互聯: 不允許VLAN 100與100外通訊
├─ IPS: 啟用, 高敏感度
└─ 備註: 最高風險區域, 隔離關鍵

VLAN 200 - 網域基礎設施 (高信任):
├─ 用途: 認證與核心服務
├─ IP範圍: 10.0.200.0/24
├─ 設備:
│   ├─ AD-DC01 (10.0.200.10)
│   ├─ AD-DC02 (10.0.200.11) [副本]
│   └─ NTP/DNS02 (10.0.200.20)
├─ 防火牆規則:
│   ├─ 入站: 僅域內 (LDAP, Kerberos)
│   ├─ 出站: 無限制 (必須連接所有系統)
│   └─ 互聯: 接受來自核心與用戶區
├─ IPS: 啟用, 中敏感度
└─ 備註: 核心, 保護最嚴格

VLAN 310 - 公司內網 (中信任):
├─ 用途: 員工工作站與BYOD
├─ IP範圍: 10.0.10.0/22 (1000+設備)
├─ 設備:
│   ├─ 工作站 (100+)
│   ├─ BYOD (平板, 手機)
│   ├─ 印表機 (10+)
│   └─ 掃描儀
├─ 防火牆規則:
│   ├─ 出站: VLAN 200 (域), VLAN 220 (應用)
│   ├─ 出站: VLAN 230 (檔案)
│   ├─ 出站: DNS, NTP, 網際網路
│   └─ 禁止: 直接訪問VLAN 210 (DB)
├─ IPS: 啟用, 低敏感度 (誤報多)
└─ 備註: 最多設備, 風險高

VLAN 400 - VPN遠端 (低信任):
├─ 用途: 遠端員工進入內網
├─ IP範圍: 10.0.40.0/24
├─ 設備:
│   └─ VPN客戶端 (動態IP分配)
├─ 防火牆規則:
│   ├─ 入站: VPN伺服器 (UDP 500, 4500)
│   ├─ 出站: 與工作站相同 (但更受限)
│   └─ 禁止: 訪問敏感VLAN
├─ 檢查: MFA強制, VPN版本驗證
└─ 備註: 準予訪問 <內網

VLAN 410 - 訪客WiFi (最低信任):
├─ 用途: 訪客臨時網路
├─ IP範圍: 192.168.110.0/24 (隔離)
├─ 設備:
│   └─ 訪客無線AP (SSID: Guest-WiFi)
├─ 防火牆規則:
│   ├─ 出站: 僅網際網路 (無內網訪問!)
│   ├─ 流量: HTTP/HTTPS + DNS only
│   └─ 禁止: 所有內網VLAN
├─ 隔離: 網路隔離, 完全分開
└─ 備註: 最低安全等級, 完全隔離

VLAN 500 - 管理網路 (專用):
├─ 用途: IT管理員與監控系統
├─ IP範圍: 10.0.50.0/24 (限制訪問)
├─ 設備:
│   ├─ 堡壘主機 (Jump Host)
│   ├─ Wazuh監控伺服器
│   ├─ 防火牆管理介面
│   └─ 交換機管理IP
├─ 防火牆規則:
│   ├─ 入站: 僅堡壘主機 + MFA
│   ├─ 出站: 所有管理埠 (SSH, SNMP)
│   └─ 禁止: 一般用戶訪問
├─ 監控: 所有連接記錄, 重度監控
└─ 備註: 最敏感, 訪問嚴格控制

信任等級與訪問矩陣:

┌────────────────────────────────────┐
│ VLAN訪問規則矩陣                    │
│ (行=源, 列=目的地)                 │
├────────────────────────────────────┤
│      │100│200│210│220│310│400│500│
│      │DMZ│核│DB│應用│用│VPN│管理│
├────────────────────────────────────┤
│100DMZ │ -│✓ │✗ │✗ │✗ │✗ │✗ │
├────────────────────────────────────┤
│200核 │✗ │ - │✓ │✓ │✓ │✗ │✗ │
├────────────────────────────────────┤
│210DB │✗ │✓ │ - │✓ │✗ │✗ │✗ │
├────────────────────────────────────┤
│220應用│✓ │✓ │✓ │ - │✓ │✗ │✗ │
├────────────────────────────────────┤
│310用 │✗ │✓ │✗ │✓ │ - │✗ │✗ │
├────────────────────────────────────┤
│400VPN│✗ │✓ │✗ │✓ │✓ │ - │✗ │
├────────────────────────────────────┤
│500管 │✗ │✓ │✓ │✓ │✓ │✓ │ - │
├────────────────────────────────────┤

圖例:
✓ = 允許 (有防火牆規則)
✗ = 禁止 (防火牆阻擋)
- = 相同VLAN
```

---

### 模組1.2：實施計畫與時程 (1小時)

```
分階段實施計畫 (Phased Implementation)

第一階段: 規劃與設計 (第1-2月)
├─ 審查現有網路
├─ 設計VLAN架構
├─ 制訂防火牆規則
├─ 規劃管理工具
└─ 完成: 設計文檔與審批

第二階段: 試點實施 (第3月)
├─ 選擇1個應用作試點 (例: Web應用)
├─ 將Web伺服器移至VLAN 100 (DMZ)
├─ 配置防火牆規則
├─ 監視1週穩定性
├─ 驗證無異常, 數據一致
└─ 完成: 試點驗證報告

第三階段: 逐步部署 (第4-6月)
├─ 移遷核心系統:
│   ├─ 月1: AD與DNS (VLAN 200)
│   ├─ 月2: SQL資料庫 (VLAN 210)
│   ├─ 月3: 應用伺服器 (VLAN 220)
│   ├─ 月3: 檔案伺服器 (VLAN 230)
│   └─ 月3: 工作站VLAN化 (VLAN 310)
├─ 每次遷移後: 24小時監視, 建立回退計畫
└─ 完成: 核心系統分段

第四階段: 監控與優化 (第7-12月)
├─ 啟用IDS/IPS監控
├─ 調整防火牆規則 (減少誤報)
├─ 優化效能 (移除不必要的限制)
├─ 員工培訓與溝通
├─ 改善與持續最佳化
└─ 完成: 穩定運營

實施時程表:

月份  │ 活動        │ 風險     │ 工作量
──────┼─────────────┼─────────┼──────
1月   │ 規劃設計    │ 低      │ 40h
2月   │ 設計完成    │ 低      │ 20h
3月   │ 試點(Web)   │ 中      │ 60h
4月   │ AD+DNS遷移  │ 高 ⚠️   │ 80h
5月   │ SQL遷移     │ 高 ⚠️   │ 80h
6月   │ 應用遷移    │ 中      │ 60h
7月   │ IPS啟用     │ 中      │ 40h
8-12月│ 監控優化    │ 低      │ 40h/月

風險與緩解:

風險1: 網路中斷 (核心系統遷移)
├─ 影響: 業務停機
├─ 機率: 高 (AD/SQL都是關鍵)
├─ 緩解:
│   ├─ 規劃維護窗口 (停機時段)
│   ├─ 提前24小時通知所有用戶
│   ├─ 建立回退計畫 (舊配置備份)
│   ├─ 測試環境先試驗
│   └─ 現場駐守 (立即修復)
└─ SLA: <30分鐘恢復

風險2: 應用相容性 (網路變化)
├─ 影響: 應用異常, 連接失敗
├─ 機率: 中等
├─ 緩解:
│   ├─ 提前與應用所有者溝通
│   ├─ 更新應用連接字串 (hostname)
│   ├─ 測試應用連接
│   └─ 應用廠商支援待命
└─ SLA: <4小時解決

風險3: 防火牆規則遺漏
├─ 影響: 正常流量被阻擋
├─ 機率: 中等 (規則複雜)
├─ 緩解:
│   ├─ 在試點階段充分測試
│   ├─ 使用防火牆日誌分析
│   ├─ 快速增加允許規則
│   └─ 監控告警設置
└─ SLA: <2小時修復
```

---

## 第二至三天：防火牆規則與最小權限
## Days 2-3: Firewall Rules & Least Privilege (4 hours)

### 模組2.1：防火牆規則制訂 (2小時)

```
防火牆規則編寫原則 (Firewall Rule Development Principles)

最小權限原則 (Least Privilege):
├─ 默認拒絕 (Deny by Default)
│   └─ 所有流量預設被拒, 除非明確允許
├─ 只允許必需 (Allow Only What's Needed)
│   └─ 只開放必需的埠與協議
├─ 細粒度控制 (Granular Control)
│   └─ 用戶/應用/伺服器級別的限制
└─ 定期評審 (Regular Review)
    └─ 月度審查, 移除過時規則

防火牆規則結構:

每條規則需要定義:

1. 規則編號 (Rule ID):
   └─ 例: FW-001, FW-002 (便於追蹤與修改)

2. 名稱 (Name):
   └─ 例: "Allow-User-to-AppServer"
   └─ 清晰描述用途, 便於後續審查

3. 優先級 (Priority):
   └─ 規則評估順序 (上到下)
   └─ 更具體的規則應優先於通用規則

4. 源 (Source):
   └─ 來自哪些IP/VLAN?
   └─ 例: VLAN 310 (工作站)
   └─ 或具體IP: 10.0.10.0/24

5. 目的地 (Destination):
   └─ 流向哪些IP/伺服器?
   └─ 例: VLAN 220 (應用伺服器)
   └─ 或具體IP: 10.0.220.10

6. 服務/埠 (Service/Port):
   └─ 允許哪些埠與協議?
   └─ 例: TCP 80 (HTTP)
   └─ 或 TCP 1433 (SQL Server)
   └─ 或 UDP 53 (DNS)

7. 動作 (Action):
   └─ Allow (允許)
   └─ Deny (拒絕)
   └─ Log (記錄)

8. 日誌 (Logging):
   └─ 是否記錄此規則的流量?
   └─ 關鍵規則: 必須啟用日誌

9. 備註 (Comments):
   └─ 制訂原因與業務用途
   └─ 例: "Web應用需要連接SQL資料庫"
   └─ 例: "聯絡人: 應用所有者 李四"

防火牆規則範例:

規則組A: 外部訪問 (DMZ入站)

┌──────────────────────────────────────┐
│ FW-101: Allow Internet → Web HTTP   │
├──────────────────────────────────────┤
│ 優先級: 10                           │
│ 源: 0.0.0.0/0 (任何網際網路)        │
│ 目的地: 192.168.100.10-11 (Web伺服器│
│ 服務: TCP 80 (HTTP)                  │
│ 動作: Allow                          │
│ 日誌: Yes (監視攻擊)                │
│ 備註: 公共網站訪問                  │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ FW-102: Allow Internet → Web HTTPS  │
├──────────────────────────────────────┤
│ 優先級: 11                           │
│ 源: 0.0.0.0/0 (任何網際網路)        │
│ 目的地: 192.168.100.10-11 (Web伺服器│
│ 服務: TCP 443 (HTTPS)               │
│ 動作: Allow                          │
│ 日誌: Yes                            │
│ 備註: 安全網站訪問                  │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ FW-103: Deny Internet → DMZ (其他)  │
├──────────────────────────────────────┤
│ 優先級: 12 (規則組結尾 - 默認拒絕)  │
│ 源: 0.0.0.0/0                        │
│ 目的地: 192.168.100.0/24 (DMZ)      │
│ 服務: Any                            │
│ 動作: Deny                           │
│ 日誌: Yes (入侵檢測)                │
│ 備註: 默認拒絕 - 安全原則            │
└──────────────────────────────────────┘

規則組B: 內網訪問 (核心系統)

┌──────────────────────────────────────┐
│ FW-201: User → Domain Services      │
├──────────────────────────────────────┤
│ 優先級: 20                           │
│ 源: VLAN 310 (工作站)                │
│ 目的地: VLAN 200 (AD/DNS)            │
│ 服務: 
│   └─ TCP/UDP 53 (DNS)
│   └─ TCP 88 (Kerberos)
│   └─ TCP 389 (LDAP)
│   └─ TCP 636 (LDAPS)
│ 動作: Allow                          │
│ 日誌: No (正常流量, 日誌過多)       │
│ 備註: 域認證與查詢                  │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ FW-202: User → Application Server   │
├──────────────────────────────────────┤
│ 優先級: 21                           │
│ 源: VLAN 310 (工作站)                │
│ 目的地: VLAN 220 (應用伺服器)        │
│ 服務: 
│   └─ TCP 80 (HTTP)
│   └─ TCP 443 (HTTPS)
│   └─ TCP 8080 (應用埠)
│ 動作: Allow                          │
│ 日誌: No                             │
│ 備註: 應用訪問                      │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ FW-203: User → File Server          │
├──────────────────────────────────────┤
│ 優先級: 22                           │
│ 源: VLAN 310 (工作站)                │
│ 目的地: VLAN 230 (檔案伺服器)        │
│ 服務: 
│   └─ TCP 445 (SMB/CIFS)
│   └─ TCP 139 (NetBIOS)
│ 動作: Allow                          │
│ 日誌: No                             │
│ 備註: 檔案共享訪問                  │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ FW-204: Deny User → Database        │
├──────────────────────────────────────┤
│ 優先級: 23                           │
│ 源: VLAN 310 (工作站)                │
│ 目的地: VLAN 210 (SQL資料庫)         │
│ 服務: TCP 1433 (SQL Server)         │
│ 動作: Deny                           │
│ 日誌: Yes (異常偵測)                │
│ 備註: 工作站禁止直接訪問資料庫      │
│       應透過應用伺服器               │
└──────────────────────────────────────┘

規則組C: 管理訪問 (堡壘機)

┌──────────────────────────────────────┐
│ FW-301: Admin → Bastion Host        │
├──────────────────────────────────────┤
│ 優先級: 30                           │
│ 源: 管理員IP白名單 (5個IP)         │
│ 目的地: VLAN 500 堡壘主機           │
│ 服務: TCP 22 (SSH) + MFA            │
│ 動作: Allow                          │
│ 日誌: Yes (所有管理訪問)            │
│ 備註: 只允許授權管理員               │
│       通過堡壘進入管理網路          │
└──────────────────────────────────────┘

防火牆規則評審流程:

月度規則評審 (Monthly Review):

Step 1: 收集規則變更
└─ 本月新增/修改/刪除了哪些規則?
└─ 記錄所有變更與原因

Step 2: 驗證必要性
└─ 每條規則是否仍然必需?
└─ 是否有未使用的規則可刪除?

Step 3: 檢查過度開放
└─ 是否有過於寬鬆的規則? (0.0.0.0/0)
└─ 是否可縮小源IP範圍?

Step 4: 審查日誌
└─ 檢查被拒絕流量日誌
└─ 是否有合法流量被誤拒?

Step 5: 簽批與文檔
└─ 網路工程師簽批
└─ IT主管核准
└─ 保存變更紀錄

防火牆規則清單 (本公司規則數: ~150條):

┌────────────────────────────────────┐
│ 防火牆規則摘要                     │
├────────────────────────────────────┤
│ 規則組      │ 數量 │ 目的          │
├────────────────────────────────────┤
│ 外部入站    │ 15  │ DMZ防護       │
│ 內部出站    │ 25  │ 使用者存取    │
│ 伺服器互聯  │ 40  │ 應用通訊      │
│ 管理訪問    │ 20  │ 堡壘機存取    │
│ 默認規則    │ 10  │ 日誌與統計    │
│ 臨時規則    │  5  │ 故障排除      │
│ (待移除)    │     │ (30天後刪除) │
├────────────────────────────────────┤
│ 合計        │150  │              │
│ 平均更新    │ 3-5  │ 規則/月       │
│ 最後審查    │今月  │              │
│ 下次審查    │下月  │ (月度循環)   │
└────────────────────────────────────┘
```

---

### 模組2.2：最小權限實踐案例 (2小時)

```
案例1: SQL資料庫訪問最小權限

情景: 應用伺服器需訪問SQL資料庫

❌ 錯誤做法 (過度開放):
├─ FW規則: Allow 10.0.220.0/24 → 10.0.210.10 TCP 1433
├─ 問題:
│   ├─ VLAN 220內所有伺服器都可訪問SQL
│   ├─ 不同應用可能訪問不需要的資料庫
│   ├─ 測試機也可訪問生產資料庫
│   └─ 駭客入侵1台應用伺服器 → 直接訪問所有資料庫
└─ 風險等級: 🔴 高

✅ 正確做法 (最小權限):

Step 1: 明確確定需求
└─ 哪個應用需要訪問SQL?
    └─ App-ERP (IP 10.0.220.10)
└─ 訪問哪個資料庫?
    └─ CompanyDB
└─ 何時訪問?
    └─ 營業時間 08:00-18:00
└─ 使用什麼帳號?
    └─ app_erp_user (只讀權限)

Step 2: 配置防火牆規則 (防火牆層)
├─ FW-401: Allow AppERP → SQL DB
│   ├─ 源: 10.0.220.10 (只有1台伺服器!)
│   ├─ 目的地: 10.0.210.10 TCP 1433
│   ├─ 時間表: 08:00-18:00 (營業時間)
│   └─ 日誌: Yes (監視訪問)

Step 3: 配置資料庫權限 (應用層)
├─ 資料庫帳號: app_erp_user
├─ 密碼: 高強度, 存放VAULT
├─ 權限: 
│   ├─ SELECT (查詢) ✓
│   ├─ INSERT/UPDATE ✓ (新增/修改資料)
│   ├─ DELETE ✗ (禁止刪除)
│   ├─ ALTER/DROP ✗ (禁止修改表結構)
│   └─ 資料庫範圍: 僅CompanyDB
└─ 稽核: 所有查詢日誌記錄

Step 4: 配置應用層檢查
├─ 應用連接字串:
│   └─ Server=10.0.210.10;User=app_erp_user;
│   └─ InitialCatalog=CompanyDB;
├─ 應用應驗證:
│   ├─ 存取的表格是否應被應用訪問?
│   ├─ 是否檢查用戶權限 (誰在查詢)?
│   └─ 是否記錄所有查詢?

Step 5: 監控與審計
├─ 防火牆日誌:
│   ├─ 每日報告連接數
│   ├─ 監視異常時段訪問
│   └─ 監視異常IP訪問
├─ 資料庫日誌:
│   ├─ 記錄所有查詢
│   ├─ 監視 DELETE 語句 (應該沒有)
│   └─ 月度審查
└─ 應用日誌:
    ├─ 記錄哪個用戶執行了什麼查詢
    └─ 月度存取報告

好處:
✅ 駭客入侵應用伺服器 → 無法訪問其他資料庫
✅ 駭客竊取app_erp帳號 → 只能讀CompanyDB, 無法刪除資料
✅ 員工誤操作 → 可審計追蹤
✅ 供應商漏洞 → 損害有限
✅ 完全符合ISO 27001 A9.1, A9.2要求

─────────────────────────────────────

案例2: 遠端VPN訪問最小權限

情景: 遠端員工需透過VPN訪問內部系統

❌ 錯誤做法:
├─ VPN規則: Allow 10.0.40.0/24 → 0.0.0.0/0
├─ 問題: VPN用戶可訪問所有內部系統 (無限制!)
└─ 風險: 💀 嚴重

✅ 正確做法:

Step 1: VPN用戶分類
├─ 普通員工 (100人)
│   └─ 只需存取: 應用(VLAN 220) + 檔案(VLAN 230)
├─ 工程師 (20人)
│   └─ 需存取: 上述 + 開發(VLAN 600)
└─ IT管理員 (5人)
    └─ 需存取: 所有VLAN + 堡壘機

Step 2: VPN連接規則
├─ FW-401: Allow VPN User → Application
│   ├─ 源: VLAN 400 (VPN users)
│   ├─ 目的地: VLAN 220 (應用)
│   ├─ 需求: MFA驗證
│   └─ 日誌: Yes
├─ FW-402: Allow VPN User → File
│   ├─ 源: VLAN 400
│   ├─ 目的地: VLAN 230 (檔案)
│   ├─ 需求: MFA驗證
│   └─ 日誌: Yes
└─ FW-403: Deny VPN → Database/Core
    ├─ 源: VLAN 400
    ├─ 目的地: VLAN 200, 210
    ├─ 動作: Deny
    └─ 日誌: Yes (監視異常訪問)

Step 3: VPN用戶檢查
├─ 強制MFA (Okta驗證)
├─ VPN用戶端版本檢查
├─ 防毒軟體檢查
├─ 終端設備註冊檢查 (已授權)
└─ 連接時間限制 (業務時間)

Step 4: 應用層訪問控制
├─ 應用需驗證用戶身份 (LDAP/AD)
├─ 應用需驗證用戶角色 (工程師 vs 普通員工)
├─ 應用需檢查時間戳 (非營業時間警告)
└─ 應用需記錄所有訪問

好處:
✅ 遠端員工只能訪問授權系統
✅ VPN被破密 → 無法訪問敏感系統
✅ 後支員工無法訪問開發系統
✅ IT管理員訪問受限 (堡壘機+MFA)
✅ 所有訪問完全審計
```

---

## (以下為模組3-4框架，受篇幅限制)

## 第四至五天：IDS/IPS與監控
## Days 4-5: IDS/IPS & Monitoring (4 hours)

### 模組3.1：IDS/IPS部署 (2小時)

```
IDS/IPS基本概念 (Intrusion Detection/Prevention System)

IDS vs IPS區別:

IDS (偵測):
├─ 檢測異常或惡意流量
├─ 監視但不阻擋 (旁路監控)
├─ 生成告警與日誌
├─ 用途: 監測與分析
└─ 延遲: 無 (只監控)

IPS (防禦):
├─ 檢測並主動阻擋異常流量
├─ 在線監控 (資料路徑上)
├─ 即時丟棄惡意封包
├─ 用途: 防禦與阻擋
└─ 延遲: 微小 (檢查與丟棄)
├─ 風險: 可能阻擋正常流量 (誤報)

本公司部署: IDS + IPS混合
├─ 關鍵VLAN邊界: IPS (主動防禦)
├─ 監控點: IDS (告警與分析)
└─ 監控工具: Suricata (開源)

─────────────────────────────────────

Suricata部署架構 (本公司配置):

┌──────────────────────────────────┐
│ 網際網路                         │
└────────────┬──────────────────────┘
             ↓
     ┌─────────────────┐
     │ 防火牆          │ (第1道防線)
     └────────┬────────┘
              ↓
     ┌─────────────────┐
     │ Suricata IPS    │ (第2道防線)
     │ (Inline Mode)   │ 阻擋已知攻擊
     └────────┬────────┘
              ↓
     ┌─────────────────┐
     │ DMZ (VLAN 100)  │ Web伺服器
     └────────┬────────┘
              ↓
     ┌─────────────────┐
     │ Suricata IDS    │ (監控點)
     │ (Tap Mode)      │ 警告未知攻擊
     └────────┬────────┘
              ↓
     ┌─────────────────┐
     │ Wazuh SIEM      │ (分析與報告)
     │ + 威脅情報      │
     └─────────────────┘

Suricata規則 (本公司配置):

規則來源:
├─ ET Open (Emerging Threats) - 免費
│   └─ 更新頻率: 每日
│   └─ 規則數量: 50,000+
│   └─ 涵蓋: 已知惡意軟體, 漏洞利用, C&C連接
│
├─ Suricata官方規則 - 免費
│   └─ 更新頻率: 每日
│   └─ 規則數量: 10,000+
│   └─ 涵蓋: SMTP, DNS, TLS異常
│
└─ 自訂規則 (本公司)
    └─ 針對公司應用的特定偵測
    └─ 例: 檢測內部威脅行為

規則示例:

規則1: 檢測勒索軟體活動
├─ alert http any any → any 80 (
│   content:"Emotet"; 
│   sid:1000001;
│   rev:1;
│   msg:"Emotet Ransomware C&C";
│   )
├─ 邏輯: 若HTTP流量包含"Emotet"特徵 → 告警
├─ 動作: 記錄 + IPS阻擋
└─ 結果: 威脅被檢測並阻止 ✓

規則2: 檢測SQL注入
├─ alert http any any → any 80 (
│   content:"union"; 
│   content:"select"; 
│   distance:0;
│   sid:1000002;
│   msg:"SQL Injection Attempt";
│   )
├─ 邏輯: 若URL包含 union + select → 疑似SQL注入
├─ 動作: 記錄 + IPS阻擋
└─ 結果: 攻擊被檢測並阻止 ✓

Suricata告警分級:

告警等級:
├─ 🔴 Critical (紅): 立即威脅
│   └─ 例: 遠端程式碼執行 (RCE)
│   └─ 動作: 立即阻擋 + 升級
│
├─ 🟠 High (橙): 重大風險
│   └─ 例: SQL注入, 認證繞過
│   └─ 動作: 阻擋 + 1小時內審查
│
├─ 🟡 Medium (黃): 中等風險
│   └─ 例: 弱加密, 過期軟體
│   └─ 動作: 記錄 + 6小時內審查
│
└─ 🟢 Low (綠): 低風險
    └─ 例: 掃描活動, 資訊洩露
    └─ 動作: 記錄 + 日度審查

假警告 (False Positive) 處理:

問題: IDS告警過多, 90%都是假警告
├─ 原因: 規則過於敏感
├─ 結果: 告警疲勞 (警告過多被忽視)
├─ 解決:
│   ├─ 白名單 (Whitelisting): 排除已知正常流量
│   ├─ 規則微調: 調整檢測條件
│   ├─ 基準線: 學習正常網路行為
│   └─ 每周審查
└─ 目標: False Positive <10%
```

---

### 模組3.2：威脅偵測案例 (2小時)

```
案例1: 檢測勒索軟體攻擊

場景: 員工電腦感染勒索軟體

檢測流程:

1️⃣ 檔案系統異常 (Wazuh FIM檢測)
├─ 檢測到大量檔案快速加密
├─ 副檔名改變 (.docx → .cryptolocker)
└─ 告警: P0 (致命)

2️⃣ 網路異常 (Suricata檢測)
├─ 受感染機器連接到已知C&C伺服器
├─ 連接流量匹配勒索軟體特徵
├─ Suricata規則觸發: "Emotet Ransomware"
└─ 動作: IPS自動阻擋該連接

3️⃣ 防火牆告警
├─ 防火牆檢測大量異常出站流量
├─ 未授權連接到外部IP
├─ 告警: 異常出站流量

4️⃣ Wazuh關聯分析
├─ FIM (檔案變化) + IPS (網路異常) + 防火牆
├─ 多層告警關聯 → 確認勒索軟體
├─ 自動升級: P0事件
└─ 發送: CISO立即通知

5️⃣ 自動應對 (可選)
├─ 隔離受感染機器 (防火牆規則)
├─ 停用帳號 (防止橫向移動)
├─ 備份觸發警報 (停止備份以保護備份)
├─ 紀錄系統狀態 (取證)
└─ 啟動危機應變

6️⃣ 人工驗證與修復
├─ IT部長驗證感染
├─ 隔離系統 (物理或網路)
├─ 從備份恢復
├─ 驗證修復

結果:
✅ 攻擊時間線:
├─ T+0: 檔案開始加密
├─ T+2分鐘: Wazuh檢測 (FIM告警)
├─ T+4分鐘: Suricata檢測 (C&C連接)
├─ T+5分鐘: IPS阻擋 (自動)
├─ T+10分鐘: Wazuh升級 (P0)
├─ T+15分鐘: CISO通知
└─ T+45分鐘: 系統隔離與修復開始

損害評估:
- 檔案加密數量: 1,250個 (1小時內)
- 無橫向移動 (隔離及時)
- 資料可從備份恢復
- 無資料外洩 (連接被IPS阻擋)
- 業務影響: 4小時停機 (可接受)

沒有多層防禦的對比:
❌ 若無防禦:
├─ 檔案持續加密 (無檢測)
├─ 加密24小時 → 全部檔案丟失
├─ C&C連接成功 → 資料外洩
└─ 業務影響: 全公司停機 + 勒索要求

─────────────────────────────────────

案例2: 檢測內部威脅

場景: 員工試圖竊取客戶資料 (內部威脅)

檢測流程:

1️⃣ 異常檔案訪問 (Wazuh監控)
├─ 員工John Smith (工程師)
├─ 訪問 C:\Confidential\Customers.xlsx
├─ 時間: 23:45 (非營業時間) ⚠️
├─ 訪問方式: 本地USB複製
└─ 檔案大小: 500MB

2️⃣ 防火牆異常 (出站監控)
├─ John的PC向外部IP傳輸500MB
├─ 目的地: amazonaws.com (雲端服務)
├─ 協議: SFTP (加密)
├─ 時間: 23:50
└─ Suricata檢測: 異常大數據外傳

3️⃣ Wazuh關聯與提升
├─ 異常時間 + 敏感檔案 + 外傳
├─ 行為模式匹配內部威脅 (已知指標)
├─ 告警等級: P0 (數據洩露)
└─ 自動行動: 保護證據

4️⃣ 自動應對
├─ 隔離John的帳號 (防止刪除證據)
├─ 隔離他的PC (網路斷開)
├─ 備份系統狀態 (取證)
├─ 啟動日誌記錄 (完整監控)
└─ 通知: CISO + HR + 法務

5️⃣ 人工調查
├─ 取證人員分析:
│   ├─ 詳細時間線
│   ├─ 訪問的檔案列表
│   ├─ 傳輸的檔案清單
│   └─ 目的地伺服器查詢
├─ 法律部門:
│   ├─ 評估法律影響
│   ├─ 決定是否報警
│   └─ 準備員工面談
└─ 修復:
    ├─ 通知客戶 (資料保護)
    ├─ 審視訪問控制
    ├─ 加強監控
    └─ 員工教育

結果:
✅ 威脅被及時檢測與阻止
✅ 證據完整 (法律可用)
✅ 資料可以追回 (雲端)
✅ 教訓: 內部威脅與外部威脅一樣危險

檢測要點:
- 時間異常 (夜間訪問)
- 檔案敏感度 (顧客資料)
- 行為異常 (外傳加密流量)
- 多層偵測 (防火牆+檔案+網路)
```

---

## 第六天：實施與監控
## Day 6: Implementation & Monitoring (3 hours)

### 模組4.1：實施檢查清單與監控 (2小時)

```
網路分段實施檢查清單 (Implementation Checklist)

前期準備 (Pre-Implementation):
□ VLAN規劃文檔已完成
□ 防火牆規則已編寫與審查
□ 測試環境已建立 (隔離)
□ 回退計畫已制訂
□ 利益相關者已通知 (應用所有者, 用戶)
□ 備份已完成 (所有配置)
□ 在線備援已驗證 (故障轉移準備)
□ 人員培訓已完成
□ 維護窗口已預訂
□ 現場駐守計畫已準備

實施步驟 (Implementation Steps):

Step 1: 網路交換機配置
□ 各層級交換機上配置VLAN
□ 配置VLAN間路由 (三層交換)
□ 配置每個埠的VLAN分配
□ 測試VLAN隔離 (ping測試)
□ 驗證無意外連接
└─ 時間: 2-3小時 (測試環境)

Step 2: 防火牆配置
□ 匯入所有防火牆規則
□ 驗證規則順序 (優先級)
□ 測試基礎通訊 (VLAN間)
□ 測試隔離 (被拒流量)
□ 驗證日誌記錄
└─ 時間: 1-2小時

Step 3: IPS/IDS部署
□ Suricata部署於DMZ邊界 (IPS inline)
□ 部署監控點於核心區域 (IDS tap)
□ 規則載入與更新
□ 威脅情報整合
□ 告警設置配置
└─ 時間: 2小時

Step 4: 核心系統測試
□ AD域登入測試 (域控制器跨VLAN)
□ SQL連接測試 (應用→資料庫)
□ 檔案共享測試 (用戶→檔案伺服器)
□ 備份測試 (備份伺服器→全系統)
□ 監控測試 (Wazuh→受監控系統)
└─ 時間: 4-6小時 (逐個系統)

Step 5: 用戶測試
□ 工作站連接 (10個代表性PC)
□ 應用訪問 (關鍵應用)
□ 列印機訪問
□ 檔案夾共享訪問
□ 網際網路訪問
□ 報告任何失敗
└─ 時間: 2-4小時 (同時測試)

Step 6: 監控與驗證
□ 防火牆規則日誌無異常? ✓
□ IPS告警正常? (無誤報飆升)
□ Wazuh告警正常?
□ 網路效能可接受? (無延遲)
□ 所有系統穩定運行? (24小時)
└─ 時間: 24小時監視

持續監控設置:

每日監視 (Daily Monitoring):

早班 08:00:
└─ 檢查前一天防火牆告警 (異常流量?)
└─ 檢查IPS告警 (未被阻擋的攻擊?)
└─ 檢查用戶投訴 (無法訪問?)
└─ 檢查系統日誌 (錯誤?)

午班 12:00:
└─ 監控網路頻寬使用
└─ 驗證備份完成
└─ 檢查Wazuh告警

晚班 17:00:
└─ 檢查關鍵系統狀態
└─ 準備隔天維護工作
└─ 複查防火牆規則變更

週度評審 (Weekly Review):

每週一:
└─ 彙整防火牆日誌 (分析異常模式)
└─ 彙整IPS告警 (誤報vs真告警)
└─ 用戶反饋 (訪問問題?)
└─ 性能指標 (是否達成目標?)
└─ 進度報告 (給IT主管)

月度審查 (Monthly Review):

每月1日:
├─ 防火牆規則評審 (是否還需要?)
├─ 規則變更記錄 (誰改了什麼?)
├─ 安全事件分析 (有哪些入侵?)
├─ 性能優化 (調整規則?)
├─ 費用分析 (訊息量, 網路成本)
├─ 改善計畫 (下月目標?)
└─ 簽批與文檔保存

監控儀表板 (Monitoring Dashboard):

實時指標 (Real-Time Metrics):
├─ 防火牆規則匹配數 (每小時)
├─ IPS告警速率 (每小時)
│   └─ 按嚴重程度分類
├─ 被拒流量統計
│   └─ 按來源IP, 目的地IP
├─ 網路延遲 (VLAN間)
├─ 頻寬使用 (按VLAN)
└─ 活躍連接數

告警設置 (Alert Thresholds):
├─ IPS Critical告警 > 5/小時 → 升級
├─ 防火牆被拒數 > 100倍平常 → 調查
├─ 網路延遲 > 100ms → 檢查
├─ 頻寬飆升 > 80% → 警告
└─ VLAN隔離失敗 → 立即通知

月度報告範本:

┌────────────────────────────────┐
│ 2026-02月網路分段運營報告      │
├────────────────────────────────┤
│                                │
│ 執行摘要:                      │
│ ├─ 運營狀態: 正常 ✓            │
│ ├─ 安全事件: 1起 (已處理)     │
│ └─ 用戶投訴: 0起              │
│                                │
│ 性能指標:                      │
│ ├─ 可用性: 99.8% (目標99%) ✓  │
│ ├─ 平均延遲: 5ms (目標<10) ✓  │
│ └─ 頻寬使用: 45% (正常)       │
│                                │
│ 安全指標:                      │
│ ├─ IPS告警: 1,245個           │
│ │   ├─ Critical: 0個          │
│ │   ├─ High: 3個              │
│ │   ├─ Medium: 45個           │
│ │   └─ Low: 1,197個           │
│ ├─ 已阻擋攻擊: 48個           │
│ ├─ False Positive: 12% (接近目│
│ └─ 誤報率改善: 持續優化       │
│                                │
│ 規則變更:                      │
│ ├─ 新增規則: 5條              │
│ ├─ 修改規則: 8條              │
│ ├─ 刪除規則: 2條              │
│ └─ 規則合計: 155條            │
│                                │
│ 改善項:                        │
│ ├─ 調整IPS敏感度 (減少誤報)  │
│ ├─ 新增內部威脅檢測規則      │
│ └─ 優化遠端VPN訪問規則       │
│                                │
│ 計畫下月:                      │
│ ├─ 啟用應用層DPI檢測         │
│ ├─ 建立威脅情報整合          │
│ └─ 員工安全意識培訓          │
│                                │
└────────────────────────────────┘
```

---

## 課程總結與評估

```
✅ 知識目標達成:

□ 理解網路分段策略與VLAN設計
□ 掌握信任等級與訪問矩陣
□ 理解防火牆規則編寫原則
□ 掌握最小權限實踐
□ 理解IDS/IPS部署與運作
□ 掌握威脅偵測案例分析
□ 理解監控與持續改善流程
□ 理解ISO 27001 A13.1.3合規

✅ 操作能力達成:

□ 能設計多層VLAN架構
□ 能制訂防火牆規則清單
□ 能配置Suricata IDS/IPS
□ 能分析與優化防火牆規則
□ 能監控網路安全狀態
□ 能進行月度安全評審
□ 能生成運營報告

✅ 合規能力達成:

□ ISO 27001 A13.1.3 網路分段
□ A13.1.1 安全通訊協議
□ A13.1.2 邊界隔離
□ A13.1.3 邊界防火牆
□ A13.1.5 資訊內容過濾
□ A13.1.6 限制通訊埠與協議

成功指標:

├─ 網路分段: ✅ (多層VLAN實施)
├─ 訪問控制: ✅ (最小權限應用)
├─ 威脅偵測: ✅ (IDS/IPS運營)
├─ 安全告警: ✅ (關鍵告警<24h)
├─ 月度報告: ✅ (完整文檔)
├─ 稽核就緒: ✅ (完整證據)
└─ 運營效率: ✅ (自動化監控)
```

---

**文檔版本控制與簽批**：

| 版本 | 日期 | 內容 | 審批人 |
|------|------|------|--------|
| v1.0 | 2026-02-16 | 初版，防火牆與網路分段完整設計指南 | CISO |

---

**EOF - 防火牆策略與網路分段設計指南完成** ✅

恭喜！您已掌握完整的網路分段與防火牆設計能力。
準備好建立零信任網路架構！
